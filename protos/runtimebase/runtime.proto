syntax = "proto3";

option go_package = "./;runtime";

package App.Runtime;
import "google/api/annotations.proto";
import "google/protobuf/struct.proto";

service RuntimeService {

  rpc GetObjects (ObjectsRequest) returns (ObjectsResponse) {
    option (google.api.http) = {
      get: "/api/runtime"
    };
  };

  rpc GetObjectsRoot (ObjectsRequest) returns (ObjectsResponse) {
    option (google.api.http) = {
      get: "/api/runtime/root"
    };
  };

  rpc GetObjectSettingsSchema (UUID) returns (ObjectSettings) {
    option (google.api.http) = {
      get: "/api/runtime/objects/settings/schema/{uuid}"
    };
  };

  rpc GetObjectSettings (UUID) returns (ObjectSettings) {
    option (google.api.http) = {
      get: "/api/runtime/objects/settings/{uuid}"
    };
  };


  rpc ObjectRest (UUID) returns (Message) {
    option (google.api.http) = {
      post: "/api/runtime/objects/reset/{uuid}"
      body: "*"
    };
  };

  rpc UpdateObjectTransformations (ObjectTransformations) returns (Message) {
    option (google.api.http) = {
      post: "/api/runtime/objects/transformations/{uuid}"
      body: "*"
    };
  };

  rpc UpdateObjectSettings (ObjectSettings) returns (ObjectSettings) {
    option (google.api.http) = {
      post: "/api/runtime/objects/settings/{uuid}"
      body: "*"
    };
  };


  rpc GetObjectChilds (ObjectRequest) returns (ObjectsResponse) {
    option (google.api.http) = {
      get: "/api/runtime/childs/{uuid}"
    };
  };

  // will get the childs of the parents, parents. So go up the tree two levels
  rpc GetObjectParentsChilds (ObjectRequest) returns (ObjectsResponse) {
    option (google.api.http) = {
      get: "/api/runtime/grandparent/childs/{uuid}"
    };
  };

  rpc GetObject (ObjectRequest) returns (ObjectConfig) {
    option (google.api.http) = {
      get: "/api/runtime/objects/{uuid}"
    };
  };

  rpc GetObjectHelp (ObjectID) returns (ObjectHelp) {
    option (google.api.http) = {
      get: "/api/runtime/objects/help/{id}"
    };
  }


  rpc GetTreeMapRoot (ObjectsRequest) returns (ObjectsRootMap) {
    option (google.api.http) = {
      get: "/api/runtime/tree"
    };
  };

  rpc GetPalletTree (PalletRequest) returns (PalletTree) {
    option (google.api.http) = {
      get: "/api/plugins/pallet"
    };
  };

  rpc SingleObjectsDeploy (ObjectConfig) returns (ObjectConfig) {
    option (google.api.http) = {
      post: "/api/runtime/objects/update"
      body: "*"
    };
  };


  rpc ObjectsDeploy (ObjectDeploy) returns (ObjectDeploy) {
    option (google.api.http) = {
      post: "/api/runtime"
      body: "*"
    };
  };

  rpc Ping (PingRequest) returns (PingResponse) {
    option (google.api.http) = {
      get: "/api/ping"
    };
  };


  rpc ObjectCommand (Command) returns (CommandResponse) {
    option (google.api.http) = {
      post: "/api/command"
      body: "*"
    };
  };

  rpc RQL (Command) returns (CommandResponse) {
    option (google.api.http) = {
      post: "/api/rql"
      body: "*"
    };
  };



  rpc GetObjectsValues (ObjectsValuesRequest) returns (GetObjectValuesResponse) {
    option (google.api.http) = {
      get: "/api/runtime/objects/values"
    };
  };

  // all port values for an object
  rpc GetObjectValues (ObjectsValueRequest) returns (GetObjectValuesResponse) {
    option (google.api.http) = {
      get: "/api/runtime/objects/values/{uuid}"
    };
  };

  // single port value for an object
  rpc GetPortValue (PortRequest) returns (PortValue) {
    option (google.api.http) = {
      get: "/api/runtime/objects/{objectUUID}/port/{portID}"
    };
  };


  rpc GetHost (UUID) returns (Host) {
    option (google.api.http) = {
      get: "/api/hosts/get/{uuid}"
    };
  }

  rpc AllHosts (Empty) returns (HostList) {
    option (google.api.http) = {
      get: "/api/hosts/all"
    };
  }

  rpc DeleteHost (UUID) returns (Empty) {
    option (google.api.http) = {
      delete: "/api/hosts/delete/{uuid}"
    };
  }

  rpc EnableHost (UUID) returns (Empty) {
    option (google.api.http) = {
      post: "/api/hosts/enable/{uuid}"
    };
  }

  rpc DisableHost (UUID) returns (Empty) {
    option (google.api.http) = {
      post: "/api/hosts/disable/{uuid}"
    };
  }

  rpc UpdateHost (Host) returns (Host) {
    option (google.api.http) = {
      patch: "/api/hosts/update"
      body: "*"
    };
  }

  rpc AddHost (Host) returns (Host) {
    option (google.api.http) = {
      post: "/api/hosts/add"
      body: "*"
    };
  }

  rpc SendHostMQTT (HostMQTT) returns (HostMQTT) {
    option (google.api.http) = {
      post: "/api/hosts/mqtt"
      body: "*"
    };
  }

  rpc RegisterExtension (Extension) returns (Extension) {
    option (google.api.http) = {
      post: "/api/extensions/register"
      body: "*"
    };
  }

  rpc AddExtension (Extension) returns (Extension) {
    option (google.api.http) = {
      post: "/api/extensions/add"
      body: "*"
    };
  }

  rpc DeleteExtension (ExtensionId) returns (Empty) {
    option (google.api.http) = {
      delete: "/api/extensions/delete/{uuid}"
    };
  }

  rpc AllExtension (Empty) returns (ExtensionList) {
    option (google.api.http) = {
      get: "/api/extensions"
    };
  }

  rpc StartExtension (ExtensionId) returns (Empty) {
    option (google.api.http) = {
      post: "/api/extensions/start/{uuid}"
    };
  }

  rpc StopExtension (ExtensionId) returns (Empty) {
    option (google.api.http) = {
      post: "/api/extensions/stop/{uuid}"
    };
  }

  rpc UploadZipFile (UploadZipRequest) returns (UploadZipResponse) {
    option (google.api.http) = {
      post: "/api/runtime/upload"
      body: "*"
    };
  }

  rpc GetTickets (Empty) returns (AllTicketsResponse) {
    option (google.api.http) = {
      get: "/api/tickets"
    };
  }

  rpc PostTicket (Ticket) returns (Ticket) {
    option (google.api.http) = {
      post: "/api/tickets"
      body: "*"
    };
  }

  rpc AddComment (AddCommentRequest) returns (Ticket) {
    option (google.api.http) = {
      post: "/api/tickets/{ticketUuid}/comments/add"
      body: "*"
    };
  }

  rpc UpdateTicket (Ticket) returns (Ticket) {
    option (google.api.http) = {
      post: "/api/tickets/{uuid}/update"
      body: "*"
    };
  }

  rpc DeleteTicket (UUID) returns (Message) {
    option (google.api.http) = {
      delete: "/api/tickets/{uuid}/delete"
    };
  }

  rpc UpdateComment (UpdateCommentRequest) returns (Ticket) {
    option (google.api.http) = {
      post: "/api/tickets/{uuid}/comments/{commentUuid}/update"
      body: "*"
    };
  }

  rpc DeleteComment (UUID) returns (Message) {
    option (google.api.http) = {
      delete: "/api/tickets/{uuid}/comments/{uuid}/delete"
    };
  }

  // Teams
  rpc AddTeam (Team) returns (Team) {
    option (google.api.http) = {
      post: "/api/teams"
      body: "*"
    };
  }

  rpc UpdateTeam (Team) returns (Team) {
    option (google.api.http) = {
      patch: "/api/teams/{uuid}"
      body: "*"
    };
  }

  rpc DeleteTeam (UUID) returns (Message) {
    option (google.api.http) = {
      delete: "/api/teams/{uuid}"
    };
  }

  rpc GetAllTeams (Empty) returns (TeamsResponse) {
    option (google.api.http) = {
      get: "/api/teams"
    };
  }

  rpc GetTeam (UUID) returns (Team) {
    option (google.api.http) = {
      get: "/api/teams/{uuid}"
    };
  }

  // Users
  rpc AddUser (User) returns (User) {
    option (google.api.http) = {
      post: "/api/users"
      body: "*"
    };
  }

  rpc UpdateUser (User) returns (User) {
    option (google.api.http) = {
      patch: "/api/users/{uuid}"
      body: "*"
    };
  }

  rpc DeleteUser (UUID) returns (Message) {
    option (google.api.http) = {
      delete: "/api/users/{uuid}"
    };
  }

  rpc GetAllUsers (Empty) returns (UsersResponse) {
    option (google.api.http) = {
      get: "/api/users"
    };
  }

  rpc GetUser (UUID) returns (User) {
    option (google.api.http) = {
      get: "/api/users/{uuid}"
    };
  }


  // stream messages from the server to the plugin
  rpc ExtensionStream(stream MessageRequest) returns (stream MessageRequest);


}

message UUID {
  string uuid = 1;
}

message HostMQTT {
  string hostUUID = 1;
  string topic = 2;
  string messageUUID = 3;
  bytes body = 4;
}

message Message {
  string message = 1;
}


message HostList {
  repeated Host hosts = 1;
}

message MessageRequest {
  string extensionUUID = 1;
  string key = 2;
  ObjectConfig object = 3;
  repeated ObjectConfig pallet = 4;
  bytes body = 5;
  Command command = 6;
  string stringPayload = 7;
  string objectUUID = 8;
}


message PluginInfo {
  string name = 1;
  string uuid = 2;
  repeated ObjectConfig pallet = 4;
}

message PluginResponse {
  string message = 1;
}

message PluginList {
  repeated PluginInfo plugins = 1;
}

message GetObjectValuesResponse {
  repeated  PortValue values = 1;
}

message ObjectsValuesRequest {
  bool asBytes = 2;
}

message ObjectsValueRequest {
  string uuid = 1;
  bool asBytes = 2;
}

message PortRequest {
  string objectUUID = 1;
  string portID = 2;
}

message PortValue {
  string objectUUID = 1;
  string portID = 2;
  string dataType = 3;
  bool isNil = 4;
  bool transformationApplied = 5;
  bytes data = 6;
  optional double floatValue = 7;
  optional string stringValue = 8;
  optional bool boolValue = 9;
  optional int32 intValue = 10;
  optional string jsonValue = 12;
  optional string displayValue = 13;
  repeated string portIDs = 14;
}


message ValueTransformation {
  string unit = 1;
  bytes rawData = 2;
}


message ObjectsRequest {
  bool withData = 1;
}

message PalletRequest {
}


message PalletTree {
  map<string, Plugin> plugins = 1;
}

message Plugin {
  map<string, NestedObjectConfigMap> drivers = 1;
  map<string, NestedObjectConfigMap> rubixNetwork = 2;
  map<string, NestedObjectConfigMap> logic = 3;
  map<string, NestedObjectConfigMap> services = 4;
}

message NestedObjectConfigMap {
  map<string, ObjectConfig> entries = 1;
}

message Command {
  string targetGlobalID = 1;
  string senderGlobalID = 2;
  string targetObjectUUID = 3;
  string senderObjectUUID = 4;
  string transactionUUID = 5;
  string key = 6;
  string query = 7;
  repeated string args = 8;
  map<string, string> data = 9;
  bytes body = 10;
  ObjectConfig object = 11;
  repeated PortValue portValues = 12;
}


message ObjectPagination {
  int32 count = 1;
  int32 pageNumber = 2;
  int32 pageSize = 3;
  int32 totalPages = 4;
  int32 totalCount = 5;
  repeated PortValue PortValues = 6;

}


message CommandResponse {
  string senderID = 1;
  int32 count = 2;
  double typeFloat = 3;
  int32 typeInt = 4;
  bool typeBool = 5;
  string typeString = 7;
  string typeJson = 8;
  bytes typeByte = 9;
  string typeError = 6;
  string returnType = 10;
  map<string, string> mapStrings = 11;
  repeated CommandResponse response = 12;
  repeated ObjectConfig serializeObjects = 13;
  ObjectPagination objectPagination = 14;
  PalletTree pallet = 15;
  ObjectsRootMap objectTree = 16;
  AncestorObjectTree ancestorObjectTree = 17;
  repeated PortValue PortValues = 18;
}


// New message for the Ping request
message PingRequest {
}


// New message for the Ping response
message PingResponse {
  string message = 1;
}


message ObjectDeploy {
  repeated string deleted = 1;
  repeated ObjectConfig new = 2;
  repeated ObjectConfig updated = 3;
}


message Empty {}

message ObjectsResponse {
  repeated ObjectConfig objects = 1;
}

message ObjectHelp {
  string help = 1;
}

message ObjectID {
  string id = 1;
}

message ObjectSettings {
  string uuid = 1;
  string value = 2;
  bool persist = 4;
}

message ObjectTransformations {
  string uuid = 1;
  string portID = 2;
  bool applyTransformation = 3;
  bool persist = 4;
  google.protobuf.Struct transformation = 5;
}

message ObjectRequest {
  string uuid = 1;
  bool withPoints = 2;
}

message ObjectConfig {
  string id = 1;
  Info info = 2;
  repeated Port inputs = 3;
  repeated Port outputs = 4;
  Meta meta = 5;
  ObjectStats stats = 6;
  repeated Connection connections = 7;
  ObjectSettings settings = 8;
  repeated PortValue portValues = 9;
}


message Info {
  string objectID = 1;
  string objectType = 2;
  string category = 3;
  string pluginName = 4;
  string workingGroup = 5;
  string workingGroupLeader = 6;
  string workingGroupParent = 7;
  string icon = 8;
  repeated string workingGroupObjects = 9;
  repeated string workingGroupChildObjects = 10;
  repeated string tags = 11;
  map<string, string> metaTags = 12;
  map<string, string> flags = 13;
  Permissions permissions = 14;
  Requirements requirements = 15;
  bool isVirtualObject = 16;
  string help = 17;
  bool supportDynamicInputs = 18;
  int32 dynamicInputsMaxLimit = 19;

}


message Permissions {
  bool allPermissions = 1;
  bool canBeCreated = 2;
  bool canBeDeleted = 3;
  bool canBeUpdated = 4;
  bool readOnly = 5;
  bool allowHotFix = 6;
  bool forceDelete = 7;
}

message Requirements {
  bool callResetOnDeploy = 1;
  bool allowRuntimeAccess = 2;
  bool maxOne = 3;
  bool mustLiveInObjectType = 4;
  bool mustLiveParent = 5;
  bool requiresLogger = 6;
  bool supportsActions = 7;
  repeated string servicesRequirements = 8;
  repeated string loggerOptions = 9;
}


message ObjectStats {
  string status = 1;
  string loaded = 2;
  uint32 loopCount = 3;
  string timeSince = 6;
}


message Port {
  string id = 1;
  string name = 2;
  string portUUID = 3;
  string direction = 4;
  string dataType = 5;
  int32 defaultPosition = 6;
  google.protobuf.Struct transformation = 7;
  bool enablePersistence = 8;
  int32 xaxPersistenceCount = 9;
}


message Meta {
  string objectUUID = 1;
  string objectName = 2;
  string parentUUID = 3;
  Position position = 4;
  int32 dynamicInputsCount = 5;
}

message Position {
  int32 positionY = 1;
  int32 positionX = 2;
}


message Connection {
  string connectionUUID = 1;;
  string targetConnectionUUID = 2;
  string sourceUUID = 3;
  string sourcePort = 4;
  string sourcePortUUID = 5;
  string targetUUID = 6;
  string targetPort = 7;
  string targetPortUUID = 8;
  bool isExistingConnection = 9;
  string flowDirection = 10;
  bool disable = 11;
  bool isError = 12;
  string created = 13;
  string lastOk = 14;
  string lastFail = 15;
  int32 failCount = 16;
  repeated string error = 17;
  string wiresheetUUID = 18;
}


message ObjectExtractedDetails {
  string id = 1;
  string name = 2;
  string uuid = 3;
  string parentUUID = 4;
  string category = 5;
  string objectType = 6;
  bool isParent = 7;
  repeated ObjectExtractedDetails children = 8;
}

message ObjectsRootMap {
  string rubixNetworkName = 1;
  string rubixNetworkDesc = 2;
  repeated ObjectExtractedDetails rubixNetwork = 3;
  string driversName = 4;
  string driversDesc = 5;
  repeated ObjectExtractedDetails drivers = 6;
  string servicesName = 7;
  string servicesDesc = 8;
  repeated ObjectExtractedDetails services = 9;
  string logicName = 10;
  string logicDesc = 11;
  repeated ObjectExtractedDetails logic = 12;
}


message AncestorObjectTree {
  string uuid = 1;
  string name = 2;
  string id = 3;
  string parentUUID = 4;
  string category = 5;
  repeated AncestorObjectTree children = 6;
}

message Extension {
  string uuid = 1;
  string name = 2;
  string pid = 3;
  string status = 4;
  string fileName = 5;
  int32 port = 7;
  repeated ObjectConfig pallet = 8;
  int32 objectsCount = 9;
}

message ExtensionId {
  string uuid = 1;
}

message ExtensionList {
  repeated Extension extensions = 1;
}


message Host {
  string uuid = 1;
  string name = 2;
  string type = 3;
  string displayName = 4;
  string description = 5;
  bool enable = 6;
  string ip = 7;
  int32 port = 8;
  bool https = 9;
  string externalToken = 10;
  string imageName = 11;
  string displayColour = 12;
  bool star = 13;
  string folderName = 14;
  string lon = 15;
  string lat = 16;
}

message UploadZipRequest {
  bytes zipFile = 1;
  string destinationDir = 2;
}

message UploadZipResponse {
  string message = 1;
}


// Ticket System //
message Ticket {
  string uuid = 1;
  string title = 2;
  string raisedByUserUUID = 3;
  repeated User assignedUsers = 4;
  repeated Comment comments = 5;
  string created = 6;
  string updated = 7;
}

message Comment {
  string uuid = 1;
  string comment = 2;
  string raisedByUserUUID = 3;
  string ticketId = 4;
  string created = 5;
  string updated = 6;
}

message AllTicketsResponse {
  repeated Ticket tickets = 1;
}

message AddCommentRequest {
  string ticketUuid = 1;
  string commentText = 2;
}


message UpdateCommentRequest {
  string uuid = 1;
  string commentUuid = 2;
  string newText = 3;
}


// Users/Teams //

message Role {
  string name = 1;
  repeated string permissions = 2; // List of permissions like "C", "R", "U", "D"
}

message Team {
  string uuid = 1;
  string name = 2;
  bytes role = 3; // Each team can have multiple roles
}

message User {
  string uuid = 1;
  string username = 2;
  string password = 3;
  string teamUUID = 4;
  bool isAdmin = 6;
}

message TeamsResponse {
  repeated Team teams = 1;
}

message UsersResponse {
  repeated User users = 1;
}
